pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
local current_block
local frame
local gravity
local blk_size=8
local bottom
local right_edge
local blocks
local game_over

function _init()
	current_block=new_block()

	frame=0
	gravity=20
	bottom=128-(blk_size) 
	right_edge=(64-blk_size)
	blocks={}
	game_over=false
end

function _update()
	if(not game_over) then
		tick()
		handle_input()
	end
end

function _draw()
	cls()
	map(0,0,0,0,128,128)
	draw_block(current_block)
	foreach(blocks, draw_block)
	if (game_over) then
		print("game over")
	end
end

function tick() 
	frame+=1
	
	if (frame % gravity == 0) then
		fall(current_block)
	end
end

function handle_input()
	if (btnp(0) and can_move_left(current_block)) then
		current_block.x -= blk_size -- left
	elseif (btnp(1) and can_move_right(current_block)) then
		current_block.x+=blk_size -- right
	end
	if (btn(3)) fall(current_block)
end

function fall(block)
	if (hit_bottom(block)) then
		add(blocks, current_block)
		current_block=new_block()
		if (hit_bottom(current_block)) game_over=true -- todo: there''s a bug here if you hit the top with a non center block
	else
  block.y+=blk_size
 end
end

function hit_bottom(block)
	local min_y=bottom
	for b in all(blocks) do
		if (b.x == block.x) min_y=min(min_y, b.y)
	end
	return block.y == min_y-blk_size
end

function can_move_right(block)
 if (block.x < right_edge) then
  for b in all(blocks) do
   if (b.y == block.y and b.x == block.x+blk_size) return false
  end
  return true
 end
 return false
end

function can_move_left(block)
 if (block.x > 0) then
  for b in all(blocks) do
   if (b.y == block.y and b.x == block.x-blk_size) return false
  end
  return true
 end
 return false
end

function draw_block(block)
	rectfill(block.x+1, block.y+1, block.x+blk_size-1, block.y+blk_size-1, block.color)
end

function new_block()
	return {x=32, y=0, color=rnd(14)+2} -- no black blocks
end

__gfx__
00000000777777770000000070000000777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000711111110000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700711111110000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000711111110000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000711111110000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700711111110000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000711111110000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000711111110000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001000101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101030000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404050000000000000001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404010101010101000000000001010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000001010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
